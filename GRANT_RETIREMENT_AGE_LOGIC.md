# לוגיקת חישוב יחסי מענקים עם הגבלה לפי גיל פרישה

## סקירה כללית

המערכת עודכנה כך שחישוב החלק היחסי של מענקים פטורים ממעסיקים קודמים במסך קיבוע הזכויות מתחשב כעת **גם בגיל הפרישה של הלקוח**.

## הבעיה שנפתרה

### לפני העדכון:
המערכת חישבה את החלק היחסי של המענק רק על בסיס **32 השנים האחרונות** לפני תאריך הזכאות, אך **לא התחשבה בגיל הפרישה**.

**דוגמה לבעיה:**
- גבר שעבד מגיל 60 עד 70 (10 שנים) וקיבל מענק של 200,000 ₪
- גיל הפרישה לגברים: 67
- המערכת הישנה כללה את כל 10 השנים בחישוב
- **אבל:** רק 7 שנים (60-67) צריכות להיכלל, כי לאחר גיל 67 הוא כבר לא היה צריך לעבוד

### אחרי העדכון:
המערכת כעת:
1. מחשבת את גיל הפרישה של הלקוח (דינמית לפי תאריך לידה ומגדר)
2. מגבילה את תאריך סיום העבודה לגיל הפרישה
3. מחשבת את היחס רק על בסיס התקופה **עד גיל הפרישה**

## דוגמאות מספריות

### דוגמה 1: גבר שעבד מגיל 60 עד 70

**נתונים:**
- תאריך לידה: 01/01/1960
- תקופת עבודה: 01/01/2020 - 01/01/2030 (10 שנים)
- משכורת חודשית: 20,000 ₪
- מענק פטור שהתקבל: 200,000 ₪
- גיל פרישה: 67 (תאריך: 01/01/2027)

**חישוב:**
- תקופה כוללת: 10 שנים
- תקופה רלוונטית (עד גיל פרישה): 7 שנים (60-67)
- יחס: 7/10 = 0.7
- סכום רלוונטי: 200,000 × 0.7 = **140,000 ₪**
- סכום שלא נכלל: 200,000 × 0.3 = 60,000 ₪

### דוגמה 2: אישה שעבדה מגיל 60 עד 70

**נתונים:**
- תאריך לידה: 01/01/1975
- תקופת עבודה: 01/01/2035 - 01/01/2045 (10 שנים)
- משכורת חודשית: 20,000 ₪
- מענק פטור שהתקבל: 200,000 ₪
- גיל פרישה: 65 (תאריך: 01/01/2040)

**חישוב:**
- תקופה כוללת: 10 שנים
- תקופה רלוונטית (עד גיל פרישה): 5 שנים (60-65)
- יחס: 5/10 = 0.5
- סכום רלוונטי: 200,000 × 0.5 = **100,000 ₪**
- סכום שלא נכלל: 200,000 × 0.5 = 100,000 ₪

### דוגמה 3: עבודה שהסתיימה לפני גיל פרישה

**נתונים:**
- תקופת עבודה: 01/01/2010 - 01/01/2020 (הסתיימה בגיל 60)
- גיל פרישה: 67

**חישוב:**
- כל התקופה נכללת (כי העבודה הסתיימה לפני גיל הפרישה)
- יחס: 1.0
- סכום רלוונטי: **100% מהמענק**

## קבצים שעודכנו

### 1. `app/services/rights_fixation.py`

#### פונקציה: `work_ratio_within_last_32y()`
**שורות 105-179**

**שינויים:**
- הוספת פרמטרים: `birth_date` ו-`gender`
- חישוב תאריך גיל פרישה באמצעות `retirement_age_service`
- הגבלת `effective_end_date` לגיל הפרישה
- חישוב `total_days` על בסיס `effective_end_date` במקום `end_date`
- לוגים מפורטים להבנת החישוב

```python
def work_ratio_within_last_32y(
    start_date: Union[str, date], 
    end_date: Union[str, date], 
    elig_date: Union[str, date], 
    birth_date: Optional[Union[str, date]] = None,  # ← חדש
    gender: Optional[str] = None                     # ← חדש
) -> float:
```

#### פונקציה: `compute_grant_effect()`
**שורות 262-338**

**שינויים:**
- הוספת פרמטרים: `birth_date` ו-`gender`
- העברת הפרמטרים ל-`work_ratio_within_last_32y()`

#### פונקציה: `process_grant()`
**שורות 416-429**

**שינויים:**
- הוספת פרמטרים: `birth_date` ו-`gender`
- העברת הפרמטרים ל-`compute_grant_effect()`

#### פונקציה: `calculate_full_fixation()`
**שורות 431-467**

**שינויים:**
- שליפת `birth_date` ו-`gender` מ-`client_data`
- העברת הפרמטרים לכל קריאה ל-`process_grant()`

### 2. `app/services/indexation_service.py`

#### פונקציה: `work_ratio_within_last_32y()`
**שורות 81-150**

**שינויים זהים** ל-`rights_fixation.py` לצורך עקביות.

## אינטגרציה עם מערכת גיל הפרישה הדינמית

הלוגיקה משתמשת במערכת גיל הפרישה הדינמית הקיימת:

```python
if USE_DYNAMIC_RETIREMENT_AGE:
    from app.services.retirement_age_service import get_retirement_date
    retirement_date = get_retirement_date(birth_date, gender)
else:
    # fallback לחישוב פשוט
    retirement_age = 67 if gender.lower() in ['m', 'male', 'זכר'] else 65
    retirement_date = date(birth_date.year + retirement_age, birth_date.month, birth_date.day)
```

### גילאי פרישה:
- **גברים:** 67 (קבוע)
- **נשים:** דינמי לפי שנת לידה (60-65), ראה `RETIREMENT_AGE_IMPLEMENTATION.md`

## לוגים ואבחון

המערכת מוסיפה לוגים מפורטים:

```
[יחסי מענק] גיל פרישה מחושב: 2027-01-01 (מגדר: male)
[יחסי מענק] הגבלת תאריך סיום מ-2030-01-01 ל-2027-01-01 (גיל פרישה)
[יחסי מענק] תאריך ייחוס=2030-01-01, התחלה=2020-01-01, 
              סיום מקורי=2030-01-01, סיום אפקטיבי=2027-01-01, 
              חפיפה=2557 ימים, יחס=0.7000
```

## מקרי קצה

### 1. עבודה רק לאחר גיל פרישה
אם כל תקופת העבודה הייתה **אחרי** גיל הפרישה:
- `total_days` יהיה 0 או שלילי
- הפונקציה תחזיר `0.0`
- המענק לא יכלל בחישוב קיבוע הזכויות

### 2. חוסר נתוני לקוח
אם `birth_date` או `gender` לא מסופקים:
- המערכת תדלג על חישוב גיל פרישה
- תשתמש בלוגיקה הישנה (32 שנים בלבד)
- תוסיף warning ללוג

### 3. שגיאה בחישוב גיל פרישה
אם יש שגיאה בשירות גיל הפרישה:
- המערכת תשתמש ב-fallback (67/65)
- תוסיף warning ללוג
- תמשיך בחישוב

## בדיקות

קובץ בדיקה: `verify_grant_logic.py`

הרץ:
```bash
python verify_grant_logic.py
```

## תאימות לאחור

השינויים **תואמים לאחור**:
- כל הפרמטרים החדשים הם אופציונליים
- אם לא מסופקים - המערכת תשתמש בלוגיקה הישנה
- קוד קיים ימשיך לעבוד ללא שינויים

## סיכום

✅ המערכת כעת מתחשבת בגיל הפרישה בחישוב יחסי מענקים  
✅ תומכת בחישוב דינמי של גיל פרישה לנשים  
✅ מוסיפה לוגים מפורטים לאבחון  
✅ תואמת לאחור עם קוד קיים  
✅ כוללת fallback במקרה של שגיאות  

---

**תאריך עדכון:** 23 אוקטובר 2025  
**גרסה:** 1.0
