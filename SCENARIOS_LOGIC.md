# לוגיקת תרחישי פרישה - מפרט מקיף

## עקרונות כלליים

1. **בסיס הלוגיקה**: כל ההמרות בתרחישי הפרישה חייבות לפעול לפי חוקי ההמרה המוגדרים במערכת
2. **מחיקת יתרות**: כל יתרה שעוברת המרה חייבת להימחק מהטבלה המקורית
3. **שימור נתונים מקוריים**: כל תרחיש רץ על snapshot של הנתונים המקוריים

---

## חוקי המרה - קרן השתלמות (יוצאת מן הכלל)

### מאפיינים
- **מיקום יתרה**: טור "תגמולים"
- **מצב מס**: פטור ממס (tax_treatment="exempt")
- **ייחודיות**: טור תגמולים בדרך כלל לא ניתן להמרה להון, אבל קרן השתלמות היא יוצאת מן הכלל

### אפשרויות המרה
1. **המרה לקצבה פטורה**
   - יוצר: PensionFund עם tax_treatment="exempt"
   - חישוב: יתרה ÷ מקדם המרה
   - **לא** להמיר להכנסה נוספת!

2. **המרה לנכס הוני פטור**
   - יוצר: CapitalAsset עם tax_treatment="exempt"
   - ערך: היתרה המלאה
   - **לא הגיוני**: להמיר לקצבה ואז להוון (זה שווה להמרה ישירה להון)

3. **המרה חלקית**
   - חלק → קצבה פטורה
   - חלק → נכס הוני פטור
   - יחס מס נשמר לפי החלוקה

### מחיקת יתרה
✅ **מוטמע בקוד!**
- תרחיש 1: `_convert_education_fund_to_pension()` - עדכון הרשומה הקיימת (לא מחיקה)
- תרחיש 2/3: `_convert_education_fund_to_capital()` - מחיקה מלאה של הרשומה לאחר יצירת נכס הוני

---

## חוקי המרה - מוצרים פנסיוניים רגילים

### טור "פיצויים מעסיק נוכחי"
⛔ **אין לגעת בו בתרחישים!**
- ההמרות שלו מתבצעות במסך "עזיבת עבודה"
- התרחישים מתעלמים ממנו

### יתרות אחרות בטבלה
לפי חוקי ההמרה הקיימים:

#### ליצירת נכסים הוניים:
1. **יתרות הניתנות להמרה ישירה להון**
   - דוגמאות: פיצויים לאחר התחשבנות, תגמולי עובד עד 2000, תגמולי מעביד עד 2000
   - פעולה: המרה ישירה לנכס הוני
   - ⛔ **לא** להמיר לקצבה ואז להוון (פעולה מיותרת!)

2. **יתרות שאינן ניתנות להמרה ישירה להון**
   - פעולה: המרה לקצבה → היוון מלא
   - יחס מס: נשמר מהטור המקורי

#### ליצירת קצבאות:
- המרה לקצבה לפי חוקי ההמרה
- יחס מס: נשמר מהטור המקורי

### מחיקת יתרות
✅ **מוטמע בקוד!**
- הפונקציות `_convert_all_pension_funds_to_pension()` מעדכנות את הרשומות הקיימות
- שורות 321, 704, 983: `pf.balance = None` אחרי קביעת pension_amount
- במקרה של היוון מלא: הרשומה נמחקת לחלוטין (`self.db.delete(pf)`)
- במקרה של היוון חלקי: מעדכן רק pension_amount, **ללא החזרת balance**

---

## המרות רכיבים אחרים

### קצבאות (PensionFund)
**המרה להון (היוון)**
- יוצר: CapitalAsset
- ערך: pension_amount × annuity_factor
- יחס מס: **נשמר מהקצבה המקורית**
- מחיקה: ✅ מחיקת הקצבה המקורית

### הכנסות נוספות (AdditionalIncome)
⛔ **אין לגעת בהן!**
- לא ניתנות להמרה
- נשארות תמיד כמו שהן
- אין צורך ליצור הכנסות נוספות בתרחישים

**שגיאות נפוצות לתיקון:**
- ❌ יצירת AdditionalIncome מכספי היוון → צריך CapitalAsset
- ❌ יצירת AdditionalIncome מנכס פטור → צריך PensionFund עם tax_treatment="exempt"

### נכסי הון (CapitalAsset)
**המרה לקצבה**
- יוצר: PensionFund
- פרמטרים:
  - fund_name: שם_הנכס
  - pension_amount: current_value ÷ 200
  - pension_start_date: תאריך תשלום חד פעמי
  - annuity_factor: 200
  - tax_treatment: **זהה לנכס המקורי**
- מחיקה: ✅ מחיקת הנכס ההוני

---

## מעסיק נוכחי ועזיבת עבודה

### אם אין עזיבת עבודה במערכת
⏭️ אין צורך בטיפול - המערכת כבר עובדת נכון

### אם קיימת עזיבת עבודה
**שמירת נתונים:**
- תאריך סיום עבודה
- האם השלמת מעסיק

**לוגיקה לפי תרחיש:**

#### תרחיש 1: מקסימום קצבה
- סימון "קצבה" על הסכום הפטור
- סימון "קצבה" על הסכום החייב
- יצירת קצבה לפי יחס המס המתאים

#### תרחיש 2: מקסימום הון
- פדיון הסכום הפטור והחייב
- **בדיקה אופטימלית**: האם שימוש בפטור (פריסת מס) נותן ערך נוכחי גבוה יותר
- בחירת האפשרות הטובה ביותר

#### תרחיש 3: מאוזן
- שילוב של קצבה והון
- חלוקה לפי יחס 50/50 או אופטימיזציה אחרת

---

## תהליך ריצת תרחיש

### 1. שמירת מצב מקורי (Snapshot)
```python
original_state = self._save_current_state()
```

### 2. ביצוע המרות
- המרות מטבלת תיק פנסיוני
- המרות קצבאות
- המרות נכסי הון
- טיפול בעזיבת עבודה

### 3. מחיקת יתרות
✅ כל יתרה שהומרה - נמחקת מהטבלה המקורית

### 4. חישוב תוצאות
- סכום קצבאות
- סכום נכסי הון
- NPV משוער

### 5. שחזור מצב מקורי
```python
self._restore_state(original_state)
```

### 6. מעבר לתרחיש הבא
חזרה לשלב 1 עם התרחיש הבא

---

## סיכום תיקונים שבוצעו ✅

### ✅ תיקונים שהושלמו:

1. **המרת נכס פטור להכנסה נוספת** ✅ **תוקן!**
   - פונקציה: `_convert_exempt_capital_to_pension()` (שורות 453-494)
   - יוצר: PensionFund עם tax_treatment="exempt"
   - מוחק: את נכס ההון המקורי

2. **קרן השתלמות - לוגיקה מיוחדת** ✅ **מוטמע!**
   - פונקציה 1: `_convert_education_fund_to_pension()` (שורות 373-407)
     - מזהה קרנות השתלמות לפי fund_type
     - ממירה לקצבה פטורה עם PENSION_COEFFICIENT=200
     - משמרת את הרשומה הקיימת (עדכון במקום מחיקה)
   
   - פונקציה 2: `_convert_education_fund_to_capital()` (שורות 409-451)
     - ממירה קרן השתלמות להון פטור
     - מוחקת את הרשומה המקורית
     - נקראת בתרחישים 2 ו-3 (מקסימום הון ומאוזן)

3. **מחיקת יתרות** ✅ **מוטמע!**
   - כל פונקציות ההמרה כוללות `self.db.delete()` או עדכון רשומה
   - Snapshot mechanism שומר ומשחזר מצב בין תרחישים

4. **הפרדת קרנות השתלמות מפנסיה רגילה** ✅ **מוטמע!**
   - כל התרחישים מפרידים בין קרנות השתלמות למוצרים פנסיוניים רגילים
   - שימוש ב-`~PensionFund.fund_type.like('%השתלמות%')` לסינון

5. **אופטימיזציה של פעולות** ✅ **מוטמע!**
   - תרחיש 2/3: קרן השתלמות → ישירות להון (לא דרך קצבה)
   - מניעת המרה מיותרת (קצבה → היוון)

### 📋 פונקציות שנוספו:

#### `_convert_education_fund_to_pension()` - שורות 373-407
מטרה: המרת קרן השתלמות לקצבה פטורה (תרחיש 1)
```python
# מזהה: fund_type.like('%השתלמות%') + tax_treatment="exempt"
# פעולה: עדכון pension_amount, pension_start_date, annuity_factor
# מחיקה: לא - משמר את הרשומה
```

#### `_convert_education_fund_to_capital()` - שורות 409-451
מטרה: המרת קרן השתלמות להון פטור (תרחישים 2 ו-3)
```python
# מזהה: אותו סינון
# פעולה: יוצר CapitalAsset עם tax_treatment="exempt"
# מחיקה: כן - מוחק את הרשומה המקורית
```

#### עדכונים נוספים:
- `_convert_all_pension_funds_to_pension()` - שורה 295-301: מסנן קרנות השתלמות
- תרחיש 1: שורה 277-278: קריאה ל-`_convert_education_fund_to_pension()`
- תרחיש 2: שורות 684-688, 703-704: סינון + קריאה ל-`_convert_education_fund_to_capital()`
- תרחיש 3: שורות 973-974: קריאה ל-`_convert_education_fund_to_capital()`

---

## תיעוד טכני

### קבצים רלוונטיים:
- `app/services/retirement_scenarios.py` - לוגיקת בניית תרחישים
- `app/services/conversion_rules.py` - חוקי המרה (אם קיים)
- `app/models/*.py` - מודלים של הנתונים

### תאריך עדכון אחרון:
19/10/2025 14:00 - תיקון שגיאת Validation: payment_frequency

### 🔴 תיקון 1 - 19/10/2025 13:20:
**בעיה**: בהיוון חלקי, הקוד החזיר `balance = remaining_pension_value`
- זה גרם לכפילות: המוצר היה גם עם `pension_amount` וגם עם `balance`
- השרת לא קרס, אבל הנתונים היו שגויים

**תיקון**:
- שורה 786 (תרחיש 2): הסרת `pf.balance = keep_amount * pf.annuity_factor`
- שורה 1090 (תרחיש 3): הסרת `pf.balance = remaining_pension_value`
- **כלל**: לאחר המרה לקצבה, balance תמיד `None` (או נמחק המוצר לגמרי)

### 🔴 תיקון 2 - 19/10/2025 14:00:
**בעיה**: `ResponseValidationError` - נכסי הון נוצרו עם `payment_frequency='one_time'`
- הסכמה מקבלת רק: 'monthly', 'quarterly', 'annually'
- זה גרם ל-500 Internal Server Error בטעינת נכסי הון

**תיקון**:
- שורה 73: שינוי `payment_frequency="one_time"` → `payment_frequency="monthly"`
- נכסי הון מהיוון הם נכסים שמניבים הכנסה חודשית, לא תשלום חד-פעמי

---

**הערה חשובה**: מסמך זה הוא המקור האמת ללוגיקת תרחישי הפרישה. כל שינוי בלוגיקה צריך להתעדכן כאן.
