# לוגיקת פריסת מס - Tax Spread Logic

## סקירה כללית

פריסת מס היא שיטה לחישוב מס על מענקי פרישה וסכומים חד-פעמיים אחרים, המאפשרת להפחית את נטל המס על ידי פריסת הסכום על מספר שנים.

**⚠️ חשוב:** נכס הון הוא **תשלום חד פעמי** בתאריך אחד, לא תזרים מתמשך. פריסת המס היא רק לחישוב המס, לא לתזרים.

## איך זה עובד?

### שלב 1: חלוקת הסכום
הסכום החייב במס מתחלק שווה על מספר שנות הפריסה (N):
```
חלק_שנתי = סכום_כולל ÷ N
```

### שלב 2: חישוב מס לכל שנה
לכל שנה מחשבים את המס לפי מדרגות המס הישראליות (2024):

| מדרגה | הכנסה שנתית (₪) | שיעור מס |
|-------|-----------------|----------|
| 1 | עד 84,120 | 10% |
| 2 | 84,121 - 120,720 | 14% |
| 3 | 120,721 - 193,800 | 20% |
| 4 | 193,801 - 269,280 | 31% |
| 5 | 269,281 - 560,280 | 35% |
| 6 | 560,281 - 721,560 | 47% |
| 7 | 721,561+ | 50% |

#### חישוב המס לשנה:
```
מס_שנה = מס(הכנסה_רגילה + חלק_שנתי) - מס(הכנסה_רגילה)
```

### שלב 3: סיכום המס הכולל
```
מס_כולל = סכום(מס_שנה_1 + מס_שנה_2 + ... + מס_שנה_N)
```

### שלב 4: תשלום במודל התזרים

**תזרים בפועל:**
- **תאריך התשלום:** הסכום הכולל + כל המס המצטבר משולמים **פעם אחת** בתאריך התשלום
- **תאריכים אחרים:** אין תזרים

**הצגה בתזרים (אופציונלי - לשנים הבאות):**
- ניתן להציג שורות נוספות עם gross=0, tax=0, net=0
- זה רק להמחשה ויזואלית של שנות הפריסה
- אין השפעה בפועל על התזרים

## דוגמה מספרית

### נתונים:
- מענק פרישה: ₪600,000
- שנות פריסה: 3 שנים
- הכנסה שנתית רגילה: ₪200,000

### חישוב:
1. **חלק שנתי:** 600,000 ÷ 3 = ₪200,000 לשנה

2. **שנה 1:**
   - הכנסה כוללת: 200,000 + 200,000 = ₪400,000
   - מס על 400,000: ₪135,740
   - מס על 200,000: ₪44,140
   - **מס על המענק:** 135,740 - 44,140 = ₪91,600

3. **שנה 2 ו-3:** חישוב דומה
   - מס נוסף לכל שנה: ₪91,600

4. **מס כולל:** 91,600 × 3 = ₪274,800

### תזרים:
- **תאריך התשלום (01/01/2024):** 
  - תשלום ברוטו: ₪600,000
  - מס מצטבר: ₪274,800
  - **נטו לידיים: ₪325,200**
- **תאריכים אחרים:** אין תזרים (תשלום חד פעמי!)

**הערה:** ניתן להציג שורות נוספות ב-01/01/2025 ו-01/01/2026 עם 0 בכל השדות, רק להמחשה ויזואלית.

## יישום בקוד

### Backend (Python):
```python
# app/services/capital_asset_service.py

def calculate_spread_tax(
    taxable_amount: Decimal, 
    spread_years: int,
    annual_regular_income: Decimal = Decimal('0')
) -> Decimal:
    """חישוב מס עם פריסה לפי מדרגות."""
    # חלוקה שווה
    annual_portion = taxable_amount / Decimal(spread_years)
    
    total_spread_tax = Decimal('0')
    for year in range(spread_years):
        # מס עם מענק - מס בלי מענק
        tax_with = _calculate_tax_by_brackets(
            annual_regular_income + annual_portion
        )
        tax_without = _calculate_tax_by_brackets(
            annual_regular_income
        )
        total_spread_tax += (tax_with - tax_without)
    
    return total_spread_tax
```

### Frontend (TypeScript):
```typescript
// נכס הוני עם פריסת מס
{
  asset_type: "deposits",
  current_value: 600000,
  tax_treatment: "tax_spread",
  spread_years: 3,
  indexation_method: "none"  // ללא הצמדה לפריסה
}
```

## הערות חשובות

1. **הצמדה:** במקרה של פריסת מס, בדרך כלל אין הצמדה (`indexation_method: "none"`)

2. **הכנסה רגילה:** החישוב מדויק יותר כשיש נתון על ההכנסה השנתית הרגילה של הלקוח

3. **שנות פריסה:** נקבע לפי וותק:
   - עד 10 שנים: פריסה על שנה אחת
   - 10-15 שנים: פריסה על 2-3 שנים
   - 15-20 שנים: פריסה על 4 שנים
   - 20+ שנים: פריסה על 6 שנים

4. **תצוגה בתזרים:** בשנים שלאחר הראשונה, המס מוצג כ-0 אבל ניתן להוסיף תצוגה ויזואלית של המס המחושב

## קבצים רלוונטיים

- `app/services/capital_asset_service.py` - לוגיקת חישוב
- `app/models/capital_asset.py` - מודל הנכס ההוני
- `frontend/src/pages/CapitalAssets.tsx` - ממשק משתמש
- `app/schemas/capital_asset.py` - סכמות נתונים
