<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת יצירת לקוח ישירות</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            white-space: pre-wrap;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .success {
            color: green;
            margin-top: 10px;
        }
        .clients-list {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: right;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>בדיקת יצירת לקוח ישירות</h1>
    
    <div class="form-container">
        <h2>יצירת לקוח חדש</h2>
        <form id="clientForm">
            <div class="form-group">
                <label for="id_number">תעודת זהות:</label>
                <input type="text" id="id_number" name="id_number" required placeholder="למשל: 123456782">
            </div>
            
            <div class="form-group">
                <label for="first_name">שם פרטי:</label>
                <input type="text" id="first_name" name="first_name" required>
            </div>
            
            <div class="form-group">
                <label for="last_name">שם משפחה:</label>
                <input type="text" id="last_name" name="last_name" required>
            </div>
            
            <div class="form-group">
                <label for="birth_date">תאריך לידה:</label>
                <input type="date" id="birth_date" name="birth_date" required>
            </div>
            
            <div class="form-group">
                <label for="email">דוא"ל (אופציונלי):</label>
                <input type="email" id="email" name="email">
            </div>
            
            <div class="form-group">
                <label for="phone">טלפון (אופציונלי):</label>
                <input type="tel" id="phone" name="phone">
            </div>
            
            <button type="submit">צור לקוח</button>
        </form>
        
        <div class="success" id="successMessage"></div>
        <div class="error" id="errorMessage"></div>
        <div class="result" id="result"></div>
    </div>
    
    <div class="clients-list">
        <h2>רשימת לקוחות</h2>
        <button id="refreshButton">רענן רשימה</button>
        <div id="clientsContainer">טוען...</div>
    </div>
    
    <script>
        // Base API URL
        const API_BASE = 'http://localhost:8000/api/v1';
        
        // Function to normalize and validate Israeli ID
        function normalizeAndValidateIsraeliId(id) {
            if (!id) return {valid: false, normalized: ""};
            
            // Convert to string
            const idStr = String(id);
            
            // Remove non-digits and trim
            const normalized = idStr.replace(/\D/g, '').trim();
            
            // Check if empty
            if (!normalized) {
                return {valid: false, normalized};
            }
            
            // Zero-pad to 9 digits
            const paddedId = normalized.padStart(9, '0');
            
            // Verify length - MUST be 9 digits
            if (paddedId.length !== 9) {
                return {valid: false, normalized: paddedId};
            }
            
            // Calculate checksum using Israeli algorithm
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                let digit = parseInt(paddedId[i], 10);
                // Even positions (0, 2, 4, 6, 8) get weight 1
                if (i % 2 === 0) {
                    sum += digit;
                } 
                // Odd positions (1, 3, 5, 7) get weight 2
                else {
                    digit *= 2;
                    // If result > 9, sum the digits (equivalent to subtracting 9)
                    sum += digit > 9 ? digit - 9 : digit;
                }
            }
            
            return {valid: sum % 10 === 0, normalized: paddedId};
        }
        
        // Function to create a client
        async function createClient(clientData) {
            try {
                // Validate ID
                const idValidation = normalizeAndValidateIsraeliId(clientData.id_number);
                if (!idValidation.valid) {
                    throw new Error("תעודת זהות אינה תקינה");
                }
                
                // Validate birth date (age between 18-120)
                if (clientData.birth_date) {
                    const birthDate = new Date(clientData.birth_date);
                    const today = new Date();
                    
                    // Calculate min and max birth dates
                    const minBirthDate = new Date();
                    minBirthDate.setFullYear(today.getFullYear() - 120); // 120 years ago
                    
                    const maxBirthDate = new Date();
                    maxBirthDate.setFullYear(today.getFullYear() - 18); // 18 years ago
                    
                    if (birthDate > maxBirthDate) {
                        throw new Error('תאריך לידה לא הגיוני - גיל חייב להיות לפחות 18');
                    }
                    
                    if (birthDate < minBirthDate) {
                        throw new Error('תאריך לידה לא הגיוני - גיל מקסימלי הוא 120');
                    }
                } else {
                    throw new Error('תאריך לידה הוא שדה חובה');
                }
                
                // Add id_number_raw for backend compatibility
                const payload = {
                    ...clientData,
                    id_number_raw: clientData.id_number
                };
                
                console.log('Sending client data:', payload);
                
                const response = await fetch(`${API_BASE}/clients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData.detail) || `שגיאה ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error creating client:', error);
                throw error;
            }
        }
        
        // Function to list clients
        async function listClients() {
            try {
                const response = await fetch(`${API_BASE}/clients`);
                
                if (!response.ok) {
                    throw new Error(`שגיאה ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error listing clients:', error);
                throw error;
            }
        }
        
        // Function to render clients table
        function renderClientsTable(clients) {
            if (!clients || !clients.items || clients.items.length === 0) {
                return '<p>אין לקוחות</p>';
            }
            
            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ת"ז</th>
                            <th>שם פרטי</th>
                            <th>שם משפחה</th>
                            <th>תאריך לידה</th>
                            <th>דוא"ל</th>
                            <th>טלפון</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            clients.items.forEach(client => {
                tableHtml += `
                    <tr>
                        <td>${client.id || ''}</td>
                        <td>${client.id_number || ''}</td>
                        <td>${client.first_name || ''}</td>
                        <td>${client.last_name || ''}</td>
                        <td>${client.birth_date || ''}</td>
                        <td>${client.email || ''}</td>
                        <td>${client.phone || ''}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
                <p>סה"כ: ${clients.total} לקוחות</p>
            `;
            
            return tableHtml;
        }
        
        // Function to refresh clients list
        async function refreshClientsList() {
            const clientsContainer = document.getElementById('clientsContainer');
            clientsContainer.innerHTML = 'טוען...';
            
            try {
                const clients = await listClients();
                clientsContainer.innerHTML = renderClientsTable(clients);
            } catch (error) {
                clientsContainer.innerHTML = `<p class="error">שגיאה בטעינת לקוחות: ${error.message}</p>`;
            }
        }
        
        // Handle form submission
        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const successElement = document.getElementById('successMessage');
            const errorElement = document.getElementById('errorMessage');
            const resultElement = document.getElementById('result');
            
            successElement.textContent = '';
            errorElement.textContent = '';
            resultElement.textContent = 'שולח נתונים...';
            
            const formData = {
                id_number: document.getElementById('id_number').value.trim(),
                first_name: document.getElementById('first_name').value.trim(),
                last_name: document.getElementById('last_name').value.trim(),
                birth_date: document.getElementById('birth_date').value,
                email: document.getElementById('email').value.trim() || null,
                phone: document.getElementById('phone').value.trim() || null
            };
            
            try {
                const newClient = await createClient(formData);
                
                successElement.textContent = 'לקוח נוצר בהצלחה!';
                resultElement.textContent = JSON.stringify(newClient, null, 2);
                
                // Reset form
                document.getElementById('clientForm').reset();
                
                // Refresh clients list
                refreshClientsList();
                
            } catch (error) {
                errorElement.textContent = `שגיאה: ${error.message}`;
                resultElement.textContent = '';
            }
        });
        
        // Handle refresh button click
        document.getElementById('refreshButton').addEventListener('click', refreshClientsList);
        
        // Initial load of clients
        refreshClientsList();
    </script>
</body>
</html>
